<!DOCTYPE html>
<title>CURENT LTBWeb</title>
<style>
* {
	margin: 0;
	padding: 0;
	box-sizing: border-box;
}

#map {
	width: 100vw;
	height: 100vh;
}

.row {
  display: flex;
  flex-grow: 1;
}

.column {
  flex: 50%;
}
.flex-container {
  /* We first create a flex layout context */
    width: 25%;
  display: flex;

  /* Then we define the flow direction
     and if we allow the items to wrap
   * Remember this is the same as:
   * flex-direction: row;
   * flex-wrap: wrap;
   */
  flex-flow: row wrap;

  /* Then we define how is distributed the remaining space */
  justify-content: flex-end;
}

.vega-actions a {
        margin-right: 5px;
        z-index: 9999;
      }

</style>
<head>
    <script src="https://cdn.jsdelivr.net/npm/vega@5.6.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@4.0.0-beta.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@5.1.2"></script>

    <style media="screen">
        /* Add space between Vega-Embed links  */
        .vega-actions a {
          margin-right: 500px;
          z-index: 9999;
        }
      </style>

    <style>
        #playbackpanel {
            visibility: hidden;
            position: absolute;
            left: 25px;
            bottom: 25px;
            width: 50%;
            z-index: 9999;

            background-color: white;
            color: black;
            padding: 7px;
            border-radius: 6px;
        }

        #configpanel {
            visibility: hidden;
            position: absolute;
            left: 70px;
            top: 25px;
            z-index: 9999;

            background-color: white;
            color: black;
            padding: 7px;
            border-radius: 6px;
        }

        #configpanel table {
            width: 100%;
        }

        #configpanel tr {
            padding-top: 2px;
        }
    </style>
</head>

<body>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" crossorigin="" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-dialog@1.0.5/Leaflet.Dialog.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-sidebar-v2@3.2.1/css/leaflet-sidebar.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-search@2.9.8/src/leaflet-search.css">
<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js" crossorigin=""></script>
<script>base64arraybuffer = exports = {};</script>
<script src="https://unpkg.com/base64-arraybuffer@0.2.0/lib/base64-arraybuffer.js"></script>
<script>exports = undefined</script>
<script src="https://rawcdn.githack.com/greggman/twgl.js/0e14d352a4062e9c2242cd6fa971f738ad763a38/dist/4.x/twgl-full.min.js"></script>
<script src="https://unpkg.com/d3-delaunay@5.1.3/dist/d3-delaunay.min.js"></script>

<script src="/static/js/dime.js" type="text/javascript" crossorigin=""></script>
<script src="/static/js/NDArray.js"></script>
<script src="/static/js/DimeClient.js"></script>
<script src="/static/js/CanvasLayer.js"></script>
<script src="/static/js/TopologyLayer.js"></script>
<script src="/static/js/ContourLayer.js"></script>
<script src="/static/js/CommunicationLayer.js"></script>
<script src="/static/js/SearchLayer.js"></script>
<script src="/static/js/ZoneLayer.js"></script>
<script src="/static/js/Window.js"></script>
<script src="/static/js/TimeBox.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-dialog@1.0.5/Leaflet.Dialog.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-sidebar-v2@3.2.1/js/leaflet-sidebar.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-search@2.9.8/dist/leaflet-search.src.min.js"></script>

<div class="row">
	<div class="column" id="map"></div>
    <div class="column" id="map2" style="display: none;"></div>
    <!-- <div class="flex-container", id="plots">
        <div class="row", id="vis"> </div>
        <div class="row", id="vis2"> </div>
        <div class="row", id="vis3"> </div>
    </div> -->
</div>

    <div class="overlay" id="configpanel">
        <strong>Configuration settings</strong><br />

        <table>
            <tr>
                <td>V Angle (rad) min/max</td>
                <td><input type="text" id="opt_amin" pattern="[0-9]*(\.[0-9]*)?"> - <input type="text" id="opt_amax" pattern="[0-9]*(\.[0-9]*)?"></td>
            </tr>
            <tr>
                <td>V Magnitude (p.u.) min/max</td>
                <td><input type="text" id="opt_vmin" pattern="[0-9]*(\.[0-9]*)?"> - <input type="text" id="opt_vmax" pattern="[0-9]*(\.[0-9]*)?"></td>
            </tr>
            <tr>
                <td>Frequency (p.u.) min/max</td>
                <td><input type="text" id="opt_fmin" pattern="[0-9]*(\.[0-9]*)?"> - <input type="text" id="opt_fmax" pattern="[0-9]*(\.[0-9]*)?"></td>
            </tr>
            <tr>
                <td><label for="opt_togglemap2">Toggle 2<sup>nd</sup> Window</label></td>
                <td><input type="checkbox" id="opt_togglemap2"></td>
            </tr>
            <tr>
                <td><label for="opt_togglemap1handshake">Toggle 1<sup>st</sup> Window's Handshake</label></td>
                <td><input type="checkbox" id="opt_togglemap1handshake" checked></td>
            </tr>
            <tr>
                <td><label for="opt_togglemap2handshake">Toggle 2<sup>nd</sup> Window's Handshake</label></td>
                <td><input type="checkbox" id="opt_togglemap2handshake" checked></td>
            </tr>
            <tr>
                <td><label for="opt_togglezones">Toggle Zones</label></td>
                <td><input type="checkbox" id="opt_togglezones" checked></td>
            </tr>
            <tr>
                <!--
                Does this make sense? Wouldn't it be better to have the user
                select what zoom layer they want the bus labels to appear on?
                -->
                <td><label for="opt_togglebuslabels">Toggle Bus Labels</label></td>
                <td><input type="checkbox" id="opt_togglebuslabels"></td>
            </tr>
            <tr>
                <td rowspan="2"><label for="opt_timescale_range">Time multiplier</label></td>
                <td><input type="range" id="opt_timescale_range" min="-1" max="6" step="1" value="2"><div style="display:inline;" id="timescale_div"> 1x</div></td>
            </tr>
            <tr>
                <td><input type="text" id="opt_timescale_text" pattern="[0-9]*(\.[0-9]*)?" value="1" disabled></td>
            </tr>

            <tr>
                <td colspan="2"><input type="button" id="opt_resettime" value="Reset time"></td>
            <tr>

            <tr>
                <td rowspan="2"><label for="pbar">Progress bar</label></td>
                <td><input type="range" id="pbar" step="0.01"></td>
            </tr>
        </table>
    </div>

    <div class="overlay" id="playbackpanel">
        <input style="width: 100%;" type="range" id="playbackbar">
        <input style="float: left;" type="button" value="Pause">
        <div style="float: right;">
            <label>Playback speed: </label>
            <input type="range" min="-1" max="6" step="1" value="2">
            <input type="text" pattern="[0-9]*(\.[0-9]*)?" value="1" size="8" disabled>
        </div>
    </div>

    <script>
        let options = {
            vmin: 0.8,
            vmax: 1.2,
            amin: -1.0,
            amax: 1.0,
            fmin: 0.9998,
            fmax: 1.0002
        };

        if (document.cookie !== "") {
            document.cookie.split(';').map((d) => d.split('=')).reduce((acc, [k, v]) => { acc[k.trim()] = v.trim(); return acc; }, options);
        }

        if (window.location.hash !== "") {
            window.location.hash.substring(1).split(',').map((d) => d.split('=')).reduce((acc, [k, v]) => { acc[k] = v; return acc; }, options);
        }

        /*window.onbeforeunload = function() {
            let dt = new Date();
            dt.setTime(dt.getTime() + (365 * 24 * 60 * 60 * 1000));
            dt = dt.toUTCString();

            for (let [k, v] of Object.entries(options)) {
                document.cookie = k + "=" + v + ";expires=" + dt + ";path=/";
            }
        }*/

        const x1 = document.getElementById("map");
        const x2 = document.getElementById("map2");

        const pbar = document.getElementById("pbar");

        console.log(+window.location.port);

        const dimec1 = new DimeClient(window.location.hostname, +window.location.port + 8, 'geovis');
        const dimec2 = new DimeClient(window.location.hostname, +window.location.port + 8, 'geovis2');

        const [map1, layers1] = CreateWindow(options, x1, dimec1, 'geovis', pbar);
        const [map2, layers2] = CreateWindow(options, x2, dimec2, 'geovis2', pbar);

        // Toggle config panel button
        const panel = document.getElementById("configpanel");

        L.easyButton('<span>\u2699</span>', function(btn, map1) {
            panel.style.visibility = (panel.style.visibility === "visible" ? "hidden" : "visible");
        }).addTo(map1);

        function ToggleSecond() {
            if (opt_togglemap2.checked) {
                x2.style.display = "block";
            } else {
                x2.style.display = "none";
            }

            map1.invalidateSize();
            map2.invalidateSize();
        }

        opt_amin.value = options.amin;
        opt_amin.oninput = function() {
            const val = Number(opt_amin.value);

            if (val === val) {
                options.amin = val;

                let dt = new Date();
                dt.setTime(dt.getTime() + (365 * 24 * 60 * 60 * 1000));
                dt = dt.toUTCString();

                document.cookie = "amin=" + val + ";expires=" + dt + ";path=/";

                if (layers1.contourLayer.variableName === "theta") {
                    layers1.contourLayer.updateRange(options.amin, options.amax);
                }

                if (layers2.contourLayer.variableName === "theta") {
                    layers2.contourLayer.updateRange(options.amin, options.amax);
                }
            }
        }

        opt_amax.value = options.amax;
        opt_amax.oninput = function() {
            const val = Number(opt_amax.value);

            if (val === val) {
                options.amax = val;

                let dt = new Date();
                dt.setTime(dt.getTime() + (365 * 24 * 60 * 60 * 1000));
                dt = dt.toUTCString();

                document.cookie = "amax=" + val + ";expires=" + dt + ";path=/";

                if (layers1.contourLayer.variableName === "theta") {
                    layers1.contourLayer.updateRange(options.amin, options.amax);
                }

                if (layers2.contourLayer.variableName === "theta") {
                    layers2.contourLayer.updateRange(options.amin, options.amax);
                }
            }
        }

        opt_vmin.value = options.vmin;
        opt_vmin.oninput = function() {
            const val = Number(opt_vmin.value);

            if (val === val) {
                options.vmin = val;

                let dt = new Date();
                dt.setTime(dt.getTime() + (365 * 24 * 60 * 60 * 1000));
                dt = dt.toUTCString();

                document.cookie = "vmin=" + val + ";expires=" + dt + ";path=/";

                if (layers1.contourLayer.variableName === "V") {
                    layers1.contourLayer.updateRange(options.vmin, options.vmax);
                }

                if (layers2.contourLayer.variableName === "V") {
                    layers2.contourLayer.updateRange(options.vmin, options.vmax);
                }
            }
        }

        opt_vmax.value = options.vmax;
        opt_vmax.oninput = function() {
            const val = Number(opt_vmax.value);

            if (val === val) {
                options.vmax = val;

                let dt = new Date();
                dt.setTime(dt.getTime() + (365 * 24 * 60 * 60 * 1000));
                dt = dt.toUTCString();

                document.cookie = "vmax=" + val + ";expires=" + dt + ";path=/";

                if (layers1.contourLayer.variableName === "V") {
                    layers1.contourLayer.updateRange(options.vmin, options.vmax);
                }

                if (layers2.contourLayer.variableName === "V") {
                    layers2.contourLayer.updateRange(options.vmin, options.vmax);
                }
            }
        }

        opt_fmin.value = options.fmin;
        opt_fmin.oninput = function() {
            const val = Number(opt_fmin.value);

            if (val === val) {
                options.fmin = val;

                let dt = new Date();
                dt.setTime(dt.getTime() + (365 * 24 * 60 * 60 * 1000));
                dt = dt.toUTCString();

                document.cookie = "fmin=" + val + ";expires=" + dt + ";path=/";

                if (layers1.contourLayer.variableName === "freq") {
                    layers1.contourLayer.updateRange(options.fmin, options.fmax);
                }

                if (layers2.contourLayer.variableName === "freq") {
                    layers2.contourLayer.updateRange(options.fmin, options.fmax);
                }
            }
        }

        opt_fmax.value = options.fmax;
        opt_fmax.oninput = function() {
            const val = Number(opt_fmax.value);

            if (val === val) {
                options.fmax = val;

                let dt = new Date();
                dt.setTime(dt.getTime() + (365 * 24 * 60 * 60 * 1000));
                dt = dt.toUTCString();

                document.cookie = "fmax=" + val + ";expires=" + dt + ";path=/";

                if (layers1.contourLayer.variableName === "freq") {
                    layers1.contourLayer.updateRange(options.fmin, options.fmax);
                }

                if (layers2.contourLayer.variableName === "freq") {
                    layers2.contourLayer.updateRange(options.fmin, options.fmax);
                }
            }
        }

        const opt_togglemap2 = document.getElementById("opt_togglemap2");
        opt_togglemap2.onclick = ToggleSecond;

        const opt_togglemap1handshake = document.getElementById("opt_togglemap1handshake");
        opt_togglemap1handshake.onclick = function() {
            map1.handshake = opt_togglemap1handshake.checked;
        }

        const opt_togglemap2handshake = document.getElementById("opt_togglemap2handshake");
        opt_togglemap2handshake.onclick = function() {
            map2.handshake = opt_togglemap2handshake.checked;
        }

        const opt_togglezones = document.getElementById("opt_togglezones");
        opt_togglezones.onclick = function() {
            layers1.zoneLayer.toggleRender();
            layers2.zoneLayer.toggleRender();

            opt_togglezones.checked = layers1.zoneLayer._render;
        }

        const opt_togglebuslabels = document.getElementById("opt_togglebuslabels");
        opt_togglebuslabels.onclick = function() {
            layers1.topologyLayer._render_bus_ids = opt_togglebuslabels.checked;
            layers2.topologyLayer._render_bus_ids = opt_togglebuslabels.checked;

            layers1.topologyLayer.redraw();
            layers2.topologyLayer.redraw();
        }

        const opt_timescale_range = document.getElementById("opt_timescale_range");
        const opt_timescale_text = document.getElementById("opt_timescale_text");
        const timescale_div = document.getElementById("timescale_div");

        opt_timescale_range.oninput = function() {
            if (opt_timescale_range.value < 0) {
                opt_timescale_text.disabled = false;
                timescale_div.innerHTML = "Custom";

                const val = Number(opt_timescale_text.value);

                if (val >= 0) {
                    map1.timescale = val;
                    map2.timescale = val;
                }
            } else {
                opt_timescale_text.disabled = true;

                const vals = [
                    0.25,
                    0.5,
                    1,
                    1.5,
                    2,
                    3,
                    4
                ];

                const val = vals[Number(opt_timescale_range.value)];

                map1.timescale = val;
                map2.timescale = val;
                timescale_div.innerHTML = " " + val + "x";
            }
        }

        opt_timescale_text.oninput = function() {
            const val = Number(opt_timescale_text.value);

            if (val > 0) {
                map1.timescale = val;
                map2.timescale = val;
            }
        }

        document.getElementById("opt_resettime").onclick = function() {
            map1.resetTime();
            map2.resetTime();
        }

        // set the number of map views
        if (options.nview > 1) {
            opt_togglemap2.checked = true;
            ToggleSecond();
        }
    </script>
